<!-- templates/result.html -->
{% extends "base.html" %}

{% block title %}Результат преобразования{% endblock %}

{% block extra_css %}
<style>
    .result-header {
        background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        color: white;
        padding: 40px 0;
        margin-bottom: 40px;
    }
    
    .result-header h1 {
        font-size: 2rem;
        margin-bottom: 10px;
    }
    
    .actions-bar {
        background: white;
        padding: 20px;
        border-radius: 10px;
        box-shadow: 0 5px 15px rgba(0,0,0,0.05);
        margin-bottom: 30px;
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        align-items: center;
    }
    
    .btn-group {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
    }
    
    .btn {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
        padding: 12px 24px;
        border-radius: 8px;
        cursor: pointer;
        text-decoration: none;
        font-weight: 500;
        transition: all 0.3s ease;
    }
    
    .btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
    }
    
    .btn-success {
        background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
    }
    
    .btn-secondary {
        background: linear-gradient(135deg, #6c757d 0%, #495057 100%);
    }
    
    .btn-outline {
        background: white;
        color: #667eea;
        border: 2px solid #667eea;
    }
    
    .result-content {
        background: white;
        border-radius: 10px;
        overflow: hidden;
        box-shadow: 0 5px 15px rgba(0,0,0,0.05);
        margin-bottom: 40px;
    }
    
    .content-frame {
        width: 100%;
        height: 600px;
        border: none;
    }
    
    .info-box {
        background: #f8f9fa;
        padding: 20px;
        border-radius: 10px;
        margin-top: 30px;
    }
    
    .info-box h4 {
        margin-bottom: 15px;
        color: #333;
    }
    
    .info-box ul {
        padding-left: 20px;
        color: #666;
    }
    
    .info-box li {
        margin-bottom: 8px;
    }
    
    .scroll-top {
        position: fixed;
        bottom: 30px;
        right: 30px;
        background: #333;
        color: white;
        width: 50px;
        height: 50px;
        border-radius: 50%;
        display: none;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        z-index: 1000;
        transition: all 0.3s ease;
    }
    
    .scroll-top:hover {
        background: #667eea;
        transform: translateY(-5px);
    }
    
    @media (max-width: 768px) {
        .actions-bar {
            flex-direction: column;
            align-items: stretch;
        }
        
        .btn-group {
            flex-direction: column;
        }
        
        .btn {
            text-align: center;
            justify-content: center;
        }
        
        .content-frame {
            height: 400px;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="result-header">
    <div class="container">
        <h1>Преобразование завершено успешно!</h1>
        <p>Файл готов к просмотру, скачиванию и печати</p>
    </div>
</div>

<div class="container">
    <div class="actions-bar">
        <div class="btn-group">
            <a href="{{ url_for('download_file', temp_id=temp_id) }}" class="btn btn-success">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="white">
                    <path d="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z"/>
                </svg>
                Скачать HTML
            </a>
            
            <button type="button" onclick="printResult()" class="btn">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="white">
                    <path d="M19 8H5c-1.66 0-3 1.34-3 3v6h4v4h12v-4h4v-6c0-1.66-1.34-3-3-3zm-3 11H8v-5h8v5zm3-7c-.55 0-1-.45-1-1s.45-1 1-1 1 .45 1 1-.45 1-1 1zm-1-9H6v4h12V3z"/>
                </svg>
                Печать
            </button>
            
            <a href="{{ url_for('index') }}" class="btn btn-secondary">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="white">
                    <path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/>
                </svg>
                Новый файл
            </a>
        </div>
    </div>

    <div class="result-content">
        <iframe src="about:blank" class="content-frame" id="resultFrame"></iframe>
    </div>

    <div class="info-box">
        <h4>Что делать дальше?</h4>
        <ul>
            <li>Для скачивания HTML файла на компьютер нажмите кнопку "Скачать HTML"</li>
            <li>Для печати документа используйте кнопку "Печать"</li>
            <li>Файл будет автоматически удалён с сервера через 1 час</li>
            <li>Для конвертации нового файла нажмите "Новый файл"</li>
        </ul>
    </div>
</div>

<div class="scroll-top" id="scrollTop" onclick="window.scrollTo({top: 0, behavior: 'smooth'})">
    ↑
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const frame = document.getElementById('resultFrame');
    const scrollTopBtn = document.getElementById('scrollTop');
    let objectUrl = null;

    function printIframeContents(iframeEl) {
        if (!iframeEl || !iframeEl.contentWindow) {
            window.print();
            return;
        }
        try {
            iframeEl.contentWindow.focus();
            iframeEl.contentWindow.print();
        } catch (e) {
            // Fallback, если браузер блокирует печать iframe
            window.print();
        }
    }

    function printWhenReady() {
        // Если iframe ещё не загрузился, печатаем после события load
        try {
            const doc = frame && frame.contentDocument;
            const isReady = doc && doc.readyState === 'complete';
            if (isReady) {
                printIframeContents(frame);
            } else {
                frame.addEventListener('load', () => printIframeContents(frame), { once: true });
            }
        } catch (e) {
            frame.addEventListener('load', () => printIframeContents(frame), { once: true });
        }
    }

    // Делаем доступной из onclick
    window.printResult = printWhenReady;
    
    // Загружаем HTML в iframe
    const htmlContent = `{{ html_content|safe }}`;
    const blob = new Blob([htmlContent], {type: 'text/html'});
    objectUrl = URL.createObjectURL(blob);
    frame.src = objectUrl;
    frame.addEventListener('load', () => {
        // Освобождаем blob URL после загрузки (содержимое уже в памяти iframe)
        if (objectUrl) {
            URL.revokeObjectURL(objectUrl);
            objectUrl = null;
        }
    }, { once: true });
    
    // Показываем кнопку "Наверх" при прокрутке
    window.addEventListener('scroll', function() {
        if (window.scrollY > 300) {
            scrollTopBtn.style.display = 'flex';
        } else {
            scrollTopBtn.style.display = 'none';
        }
    });
    
    // Автоматическая прокрутка к содержимому
    setTimeout(() => {
        frame.contentWindow.scrollTo(0, 0);
    }, 100);
    
    // Автоматически запускаем печать, если есть параметр ?print
    if (window.location.search.includes('print')) {
        setTimeout(() => {
            printWhenReady();
        }, 1000);
    }
});
</script>
{% endblock %}